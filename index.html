<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>トーク相手ルーレット</title>
<style>
  body {
    font-family: sans-serif;
    text-align: center;
    padding: 20px;
    background: #f8f8f8;
  }

  h1 {
    margin-bottom: 30px;
  }

  .wheel-container {
    margin: 40px auto 10px;
    width: 320px;
    height: 320px;
    position: relative;
  }

  canvas {
    width: 100%;
    height: 100%;
  }

  /* 下向きポインタ（▼） */
  .pointer {
    width: 0;
    height: 0;
    border-left: 22px solid transparent;
    border-right: 22px solid transparent;
    border-top: 32px solid red;   /* ▼ */
    position: absolute;
    top: -4px;                    /* 位置は好みで微調整 */
    left: calc(50% - 22px);
    z-index: 100;
  }

  button {
    padding: 12px 24px;
    margin: 10px;
    font-size: 1.3rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    background: #0070f0;
    color: white;
  }

  button:disabled {
    opacity: 0.6;
    cursor: default;
  }

  button:hover:not(:disabled) {
    opacity: 0.85;
  }
</style>
</head>
<body>

<h1>LINE WORKS トーク相手ルーレット</h1>

<!-- 相手ルーレット -->
<h2>相手を決める</h2>
<div class="wheel-container">
  <div class="pointer"></div>
  <canvas id="personWheel" width="320" height="320"></canvas>
</div>
<button id="personButton" onclick="handleClick('person')">相手ルーレットを回す</button>

<hr style="margin:40px 0;">

<!-- お題ルーレット -->
<h2>お題を決める</h2>
<div class="wheel-container">
  <div class="pointer"></div>
  <canvas id="topicWheel" width="320" height="320"></canvas>
</div>
<button id="topicButton" onclick="handleClick('topic')">お題ルーレットを回す</button>

<script>
// データ
const persons = [
  "溝 誠也","麓 由紀子","中山 香","鈴木 由祈子",
  "杉本 信子","吉川 陽子","山口 志保","石橋 雄一","花田 奈美"
];

const topics = [
  "好きな食べ物は？","座右の銘は？","いつも何時頃起きる？",
  "体で痛むところある？","笑える一言","好きな漫画は？",
  "がんばったらどれくらい食べれる？"
];

// カラーパレット
const colors = [
  "#ffcc00", "#ff9900", "#ff6666",
  "#66ccff", "#66ff99", "#cc99ff",
  "#ff99cc", "#99cc33", "#3399cc"
];

// ルーレット描画（お題用はやや小さめフォント）
function drawWheel(canvasId, items, isTopic = false) {
  const canvas = document.getElementById(canvasId);
  const ctx = canvas.getContext("2d");
  const total = items.length;
  const arc = (2 * Math.PI) / total;
  const cx = canvas.width / 2;
  const cy = canvas.height / 2;
  const radius = canvas.width / 2;

  for (let i = 0; i < total; i++) {
    ctx.beginPath();
    ctx.fillStyle = colors[i % colors.length];
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, radius, arc * i, arc * (i + 1));
    ctx.fill();

    // テキスト（大きめ）
    ctx.save();
    ctx.translate(cx, cy);
    ctx.rotate(arc * i + arc / 2);
    ctx.textAlign = "right";
    ctx.fillStyle = "#000";
    ctx.font = isTopic ? "13px sans-serif" : "18px sans-serif";
    const maxWidth = isTopic ? radius - 40 : radius - 30;
    ctx.fillText(items[i], radius - 10, 5, maxWidth);
    ctx.restore();
  }
}

drawWheel("personWheel", persons, false);
drawWheel("topicWheel", topics, true);

// 状態：回転中かどうか／減速中かどうか／現在角度
const state = {
  person: { spinning: false, decel: false, angle: 0 },
  topic:  { spinning: false, decel: false, angle: 0 }
};

// 減速カーブ
function easeOutCubic(t) {
  return 1 - Math.pow(1 - t, 3);
}

// ボタンクリック：1回目で回転開始、2回目で減速停止
function handleClick(type) {
  const s = state[type];
  const button = document.getElementById(type + "Button");

  // まだ回っていない → 回転開始
  if (!s.spinning) {
    s.spinning = true;
    s.decel = false;
    button.textContent = "クリックで止める";
    spinLoop(type);
    return;
  }

  // 回転中（まだ減速していない）→ 減速して止める
  if (s.spinning && !s.decel) {
    startDecel(type);
  }
}

// 一定速度で回転し続けるループ
function spinLoop(type) {
  const s = state[type];
  if (!s.spinning || s.decel) return;

  const canvas = document.getElementById(type + "Wheel");
  const speed = 15; // deg/frame

  s.angle += speed;
  canvas.style.transform = `rotate(${s.angle}deg)`;

  requestAnimationFrame(() => spinLoop(type));
}

// 減速して止める
function startDecel(type) {
  const s = state[type];
  const canvas = document.getElementById(type + "Wheel");
  const button = document.getElementById(type + "Button");

  s.decel = true;
  button.disabled = true;

  const startAngle = s.angle;
  const extraRotation = 720 + Math.random() * 720; // 2〜4回転分
  const finalAngle = startAngle + extraRotation;

  const duration = 2000; // 2秒で減速
  const startTime = performance.now();

  function animate(now) {
    const elapsed = now - startTime;
    const t = Math.min(elapsed / duration, 1);
    const eased = easeOutCubic(t);

    s.angle = startAngle + (finalAngle - startAngle) * eased;
    canvas.style.transform = `rotate(${s.angle}deg)`;

    if (t < 1) {
      requestAnimationFrame(animate);
    } else {
      // 停止
      s.spinning = false;
      s.decel = false;
      button.disabled = false;
      button.textContent =
        (type === "person") ? "相手ルーレットを回す" : "お題ルーレットを回す";
    }
  }

  requestAnimationFrame(animate);
}
</script>

</body>
</html>
