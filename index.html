<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>トーク相手ルーレット</title>
<style>
  body {
    font-family: sans-serif;
    text-align: center;
    padding: 20px;
    background: #f8f8f8;
  }

  h1 {
    margin-bottom: 30px;
  }

  .wheel-container {
    margin: 40px auto;
    width: 300px;
    height: 300px;
    position: relative;
  }

  canvas {
    width: 100%;
    height: 100%;
  }

  /* 下向きポインタ（▼） */
  .pointer {
    width: 0;
    height: 0;
    border-left: 20px solid transparent;
    border-right: 20px solid transparent;
    border-top: 30px solid red;   /* 下向き三角形 */
    position: absolute;
    top: -2px;                    /* 必要なら微調整 */
    left: calc(50% - 20px);
    z-index: 100;
  }

  .result {
    font-size: 1.8rem;
    margin: 20px 0;
    font-weight: bold;
    min-height: 40px;
  }

  button {
    padding: 12px 20px;
    margin: 10px;
    font-size: 1.2rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    background: #0070f0;
    color: white;
  }

  button:disabled {
    opacity: 0.6;
    cursor: default;
  }

  button:hover:not(:disabled) {
    opacity: 0.85;
  }
</style>
</head>
<body>

<h1>LINE WORKS トーク相手ルーレット</h1>

<!-- 相手ルーレット -->
<h2>相手を決める</h2>
<div class="wheel-container">
  <div class="pointer"></div>
  <canvas id="personWheel" width="300" height="300"></canvas>
</div>
<div id="personResult" class="result"></div>
<button id="personButton" onclick="handleClick('person')">相手ルーレットを回す</button>

<hr style="margin:40px 0;">

<!-- お題ルーレット -->
<h2>お題を決める</h2>
<div class="wheel-container">
  <div class="pointer"></div>
  <canvas id="topicWheel" width="300" height="300"></canvas>
</div>
<div id="topicResult" class="result"></div>
<button id="topicButton" onclick="handleClick('topic')">お題ルーレットを回す</button>

<script>
// データ
const persons = [
  "溝 誠也","麓 由紀子","中山 香","鈴木 由祈子",
  "杉本 信子","吉川 陽子","山口 志保","石橋 雄一","花田 奈美"
];

const topics = [
  "好きな食べ物は？","座右の銘は？","いつも何時頃起きる？",
  "体で痛むところある？","笑える一言","好きな漫画は？",
  "がんばったらどれくらい食べれる？"
];

// カラーパレット
const colors = [
  "#ffcc00", "#ff9900", "#ff6666",
  "#66ccff", "#66ff99", "#cc99ff",
  "#ff99cc", "#99cc33", "#3399cc"
];

// ルーレット描画（お題用はフォント小さめ）
function drawWheel(canvasId, items, isTopic = false) {
  const canvas = document.getElementById(canvasId);
  const ctx = canvas.getContext("2d");
  const total = items.length;
  const arc = (2 * Math.PI) / total;

  for (let i = 0; i < total; i++) {
    ctx.beginPath();
    ctx.fillStyle = colors[i % colors.length];
    ctx.moveTo(150, 150);
    ctx.arc(150, 150, 150, arc * i, arc * (i + 1));
    ctx.fill();

    // テキスト
    ctx.save();
    ctx.translate(150, 150);
    ctx.rotate(arc * i + arc / 2);
    ctx.textAlign = "right";
    ctx.fillStyle = "#000";
    ctx.font = isTopic ? "11px sans-serif" : "14px sans-serif";

    const maxWidth = isTopic ? 115 : 140;
    ctx.fillText(items[i], 140, 5, maxWidth);
    ctx.restore();
  }
}

drawWheel("personWheel", persons, false);
drawWheel("topicWheel", topics, true);

// 状態管理
const state = {
  person: {
    spinning: false,   // 回転中か
    decel: false,      // 減速中か
    angle: 0,          // 現在の回転角度（deg）
    lastIndex: null,   // 前回当たったインデックス
    frameId: null
  },
  topic: {
    spinning: false,
    decel: false,
    angle: 0,
    lastIndex: null,
    frameId: null
  }
};

// 減速カーブ
function easeOutCubic(t) {
  return 1 - Math.pow(1 - t, 3);
}

// ボタンクリック
function handleClick(type) {
  const s = state[type];
  const button = document.getElementById(type + "Button");

  // まだ回っていない → 回転開始
  if (!s.spinning) {
    s.spinning = true;
    s.decel = false;
    button.textContent = "クリックで止める";
    spinLoop(type);
    return;
  }

  // 回転中（減速前） → 減速して止める
  if (s.spinning && !s.decel) {
    startDecel(type);
  }
}

// 一定速度で回転し続けるループ
function spinLoop(type) {
  const s = state[type];
  if (!s.spinning || s.decel) return;

  const canvas = document.getElementById(type + "Wheel");
  const speed = 15; // deg/frame

  s.angle += speed;
  canvas.style.transform = `rotate(${s.angle}deg)`;

  s.frameId = requestAnimationFrame(() => spinLoop(type));
}

// 減速してランダム位置で止める（直前の人／お題を除外）
function startDecel(type) {
  const items = (type === "person") ? persons : topics;
  const canvas = document.getElementById(type + "Wheel");
  const resultBox = document.getElementById(type + "Result");
  const button = document.getElementById(type + "Button");
  const s = state[type];

  s.decel = true;
  button.disabled = true;

  const n = items.length;
  const arcDeg = 360 / n;

  // 直前と同じインデックスを除外
  const candidates = [];
  for (let i = 0; i < n; i++) {
    if (i !== s.lastIndex) candidates.push(i);
  }
  const targetIndex =
    candidates[Math.floor(Math.random() * candidates.length)];

  // 各セグメント中央の角度（3時方向から反時計回り）
  const centerDeg = (targetIndex + 0.5) * arcDeg;

  // CSSの回転は「時計回りが正」。  
  // セグメント中央角度(centerDeg) - 回転角度(rotation) = 90deg（12時方向）になるようにしたい。
  // よって rotation = centerDeg - 90。
  let baseRotation = centerDeg - 90;
  baseRotation = ((baseRotation % 360) + 360) % 360;

  const startAngle = s.angle;
  let finalAngle = baseRotation;

  // 今の角度より十分先（3回転以上先）になるように調整
  while (finalAngle < startAngle + 1080) { // 360 * 3
    finalAngle += 360;
  }

  const duration = 2000; // 減速時間 2秒
  const startTime = performance.now();

  function decelLoop(now) {
    const elapsed = now - startTime;
    const t = Math.min(elapsed / duration, 1);
    const eased = easeOutCubic(t);

    s.angle = startAngle + (finalAngle - startAngle) * eased;
    canvas.style.transform = `rotate(${s.angle}deg)`;

    if (t < 1) {
      requestAnimationFrame(decelLoop);
    } else {
      // 停止・結果確定
      s.spinning = false;
      s.decel = false;
      s.lastIndex = targetIndex;

      resultBox.textContent = items[targetIndex];

      button.disabled = false;
      button.textContent =
        (type === "person") ? "相手ルーレットを回す" : "お題ルーレットを回す";
    }
  }

  requestAnimationFrame(decelLoop);
}
</script>

</body>
</html>
